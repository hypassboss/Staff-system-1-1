<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HYPASS ç®¡ç†ç³»çµ± 1-1</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <style>
        :root { --main: #00b900; --bg: #f8f9fa; }
        body { font-family: sans-serif; background: var(--bg); padding: 15px; margin: 0; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 15px; }
        input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; color: white; }
        .btn-green { background: var(--main); }
        .hidden { display: none; }
    </style>
</head>
<body>

<div id="status-msg" style="text-align:center; padding:20px;">ç³»çµ±åˆå§‹åŒ–ä¸­...</div>

<div id="ui-reg" class="card hidden">
    <h2 style="color:var(--main)">ğŸ‘‹ æ­¡è¿å…¥è·</h2>
    <p>è«‹å¡«å¯«åŸºæœ¬è³‡æ–™ï¼Œç³»çµ±å°‡è‡ªå‹•ç¶å®šæ‚¨çš„ LINE ID</p>
    <input type="text" id="reg-name" placeholder="çœŸå¯¦å§“å">
    <input type="tel" id="reg-phone" placeholder="è¯çµ¡é›»è©±">
    <input type="date" id="reg-date" title="åˆ°è·æ—¥æœŸ">
    <button class="btn btn-green" onclick="submitReg()">æäº¤ç™»éŒ„</button>
</div>

<div id="ui-main" class="hidden">
    <div class="card" style="background:var(--main); color:white;">
        <h2 id="display-name" style="margin:0;">å§“å</h2>
        <div id="display-leave" style="margin-top:10px; font-size:14px;">å¹´è³‡å‡è¨ˆç®—ä¸­...</div>
    </div>
    
    <button class="btn btn-green" style="margin-bottom:15px;" onclick="doClock('ä¸Šç­')">ğŸ“ ä¸Šç­æ‰“å¡</button>
    
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
        <div class="card" style="text-align:center" onclick="viewSalary()">ğŸ’° è–ªè³‡æ˜ç´°</div>
        <div class="card" style="text-align:center" onclick="alert('è«‹å‡æ¨¡çµ„é€£ç·šä¸­')">ğŸ“… ç”³è«‹è«‹å‡</div>
    </div>
</div>

<script>
    // âš ï¸ å¡«å…¥æ‚¨çš„è³‡è¨Š
    const S_URL = 'https://wbfaietjjgfgmgncxkbt.supabase.co';
    const S_KEY = 'sb_publishable_H5C7ddbzCgfKUp7MAQrUDQ_A9mGl_Pk';
    const L_ID = '2009127303-4vmwjtZT';
    const supabaseClient = supabase.createClient(S_URL, S_KEY);

    async function init() {
        try {
            await liff.init({ liffId: L_ID });
            if (!liff.isLoggedIn()) { liff.login(); }
            else { checkUser(); }
        } catch (e) { alert("åˆå§‹åŒ–å¤±æ•—: " + e.message); }
    }

    async function checkUser() {
        const profile = await liff.getProfile();
        const { data, error } = await supabaseClient.from('employees').select('*').eq('line_id', profile.userId).single();
        
        document.getElementById('status-msg').classList.add('hidden');
        if (data) { renderMain(data); } 
        else { document.getElementById('ui-reg').classList.remove('hidden'); }
    }

    async function submitReg() {
        const profile = await liff.getProfile();
        const { error } = await supabaseClient.from('employees').insert([{
            line_id: profile.userId,
            name: document.getElementById('reg-name').value,
            phone: document.getElementById('reg-phone').value,
            onboard_date: document.getElementById('reg-date').value
        }]);
        if (!error) { alert("è¨»å†ŠæˆåŠŸï¼è«‹è¯ç¹«è€é—†æ ¸è–ªã€‚"); location.reload(); }
    }

    function renderMain(user) {
        document.getElementById('ui-main').classList.remove('hidden');
        document.getElementById('display-name').innerText = user.name;
        
        // --- è‡ªå‹•ç®—å‡é‚è¼¯ (å°ç£å‹åŸºæ³•æ¨™æº–) ---
        const start = new Date(user.onboard_date);
        const now = new Date();
        const months = (now.getFullYear() - start.getFullYear()) * 12 + (now.getMonth() - start.getMonth());
        
        let total = 0;
        if (months >= 6 && months < 12) total = 3;
        else if (months >= 12 && months < 24) total = 7;
        else if (months >= 24) total = 10;
        
        document.getElementById('display-leave').innerText = `å…¥è·æ—¥ï¼š${user.onboard_date} | ç‰¹ä¼‘å‰©é¤˜ï¼š${total - (user.annual_leave_used || 0)} å¤©`;
    }

    async function doClock(type) {
        const profile = await liff.getProfile();
        await supabaseClient.from('attendance').insert([{ line_id: profile.userId, type: type }]);
        alert(type + " æ‰“å¡æˆåŠŸï¼");
    }

    init();
</script>
</body>
</html>
