<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å“¡å·¥ç®¡ç†ç³»çµ± 1-1</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <style>
        :root { --main-green: #00b900; --bg: #f8f9fa; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 0; }
        .header { background: var(--main-green); color: white; padding: 25px; text-align: center; border-radius: 0 0 25px 25px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .container { padding: 15px; max-width: 500px; margin: auto; }
        .card { background: white; padding: 20px; border-radius: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .user-name { font-size: 20px; font-weight: bold; margin: 0; }
        .user-detail { color: #666; font-size: 14px; margin-top: 5px; }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 12px; font-size: 17px; font-weight: bold; cursor: pointer; margin-top: 10px; transition: 0.2s; }
        .btn-checkin { background: var(--main-green); color: white; }
        .btn-checkin:active { background: #009500; }
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 10px; }
        .menu-item { background: white; padding: 20px; border-radius: 15px; text-align: center; border: 1px solid #eee; font-weight: bold; cursor: pointer; }
        .menu-item i { display: block; font-size: 24px; margin-bottom: 8px; }
    </style>
</head>
<body>

<div class="header">
    <h2 style="margin:0;">HYPASS ç®¡ç†ç³»çµ± 1-1</h2>
    <div id="conn-status" style="font-size:12px; opacity:0.8;">è³‡æ–™åº«é€£ç·šä¸­...</div>
</div>

<div class="container">
    <div class="card">
        <p id="user-name" class="user-name">è¼‰å…¥ä¸­...</p>
        <p id="user-detail" class="user-detail">æ­£åœ¨åŒæ­¥å“¡å·¥æª”æ¡ˆ...</p>
    </div>

    <button class="btn btn-checkin" onclick="handleCheckIn()">ğŸ“ ä¸Šä¸‹ç­æ‰“å¡</button>

    <div class="menu-grid">
        <div class="menu-item" onclick="showBasic()">ğŸ‘¤ åŸºæœ¬è³‡æ–™</div>
        <div class="menu-item" onclick="showSalary()">ğŸ’° è–ªè³‡æŸ¥è©¢</div>
        <div class="menu-item" onclick="showLeave()">ğŸ“… è«‹å‡ç”³è«‹</div>
        <div class="menu-item" onclick="showPerf()">ğŸ“ˆ è€ƒç¸¾é”æˆç‡</div>
    </div>
</div>

<script>
    // âš ï¸ è«‹å¡«å…¥æ‚¨çš„å°ˆå±¬è³‡è¨Š
    const SUPABASE_URL = 'https://wbfaietjjgfgmgncxkbt.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_H5C7ddbzCgfKUp7MAQrUDQ_A9mGl_Pk'; 
    const LIFF_ID = '2009127303-uI5m9ZYG';

    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    let currentUser = null;

    async function init() {
        try {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) {
                liff.login();
            } else {
                const profile = await liff.getProfile();
                document.getElementById('user-name').innerText = profile.displayName;
                document.getElementById('conn-status').innerText = "âœ… ç³»çµ±å·²å°±ç·’";
                loadEmployee(profile.userId);
            }
        } catch (err) {
            document.getElementById('conn-status').innerText = "âŒ é€£ç·šå¤±æ•—: " + err.message;
        }
    }

    async function loadEmployee(lineId) {
        const { data, error } = await supabaseClient.from('employees').select('*').eq('line_id', lineId).single();
        if (data) {
            currentUser = data;
            document.getElementById('user-detail').innerText = `å…¥è·ï¼š${data.onboard_date} | ç‰¹ä¼‘ï¼š${data.annual_leave_days}å¤©`;
        } else {
            document.getElementById('user-detail').innerText = "æœªç™»éŒ„å“¡å·¥ï¼Œè«‹è¯ç¹«è€é—†ç¶å®š LINE ID";
        }
    }

    async function handleCheckIn() {
        const profile = await liff.getProfile();
        const { error } = await supabaseClient.from('attendance').insert([{ line_id: profile.userId, type: 'æ‰“å¡' }]);
        if (!error) alert("ğŸ“ æ‰“å¡æˆåŠŸï¼æ™‚é–“å·²å­˜å…¥å¾Œå°ã€‚");
    }

    function showBasic() {
        if (!currentUser) return;
        alert(`ã€å“¡å·¥æª”æ¡ˆã€‘\nå§“åï¼š${currentUser.name}\né›»è©±ï¼š${currentUser.phone}\nåœ°å€ï¼š${currentUser.address}`);
    }

    function showSalary() {
        if (!currentUser) return;
        const total = currentUser.base_salary + currentUser.full_attendance_bonus - currentUser.labor_health_ins;
        alert(`ã€æœ¬æœˆè–ªè³‡æ˜ç´°ã€‘\nåº•è–ªï¼š$${currentUser.base_salary}\nå…¨å‹¤ï¼š$${currentUser.full_attendance_bonus}\nå‹å¥ä¿ï¼š-$${currentUser.labor_health_ins}\n--------------\nå¯¦é ˜ï¼š$${total}`);
    }

    async function showPerf() {
        const profile = await liff.getProfile();
        const { data } = await supabaseClient.from('performance').select('*').eq('line_id', profile.userId).order('id', {ascending:false}).limit(1).single();
        if (data) {
            alert(`ã€å­£åº¦è€ƒç¸¾ã€‘\né”æˆç‡ï¼š${data.achievement_rate * 100}%\nè€ƒç¸¾è©•åˆ†ï¼š${data.score}\nè€é—†è©•èªï¼š${data.comments}`);
        } else {
            alert("å°šç„¡è€ƒç¸¾è³‡æ–™");
        }
    }

    function showLeave() {
        alert("è«‹å‡æ¨¡çµ„å·²å•Ÿå‹•ï¼Œç”³è«‹å°‡é€è‡³è€é—†å¾Œå°æ ¸å‡†");
    }

    init();
</script>
</body>
</html>
