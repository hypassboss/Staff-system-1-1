<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å“¡å·¥ç®¡ç†ç³»çµ± 1-1</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <style>
        :root { --primary: #00b900; --bg: #f4f7f6; --text: #333; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; padding: 15px; color: var(--text); }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 15px; }
        .header { background: var(--primary); color: white; padding: 20px; text-align: center; border-radius: 0 0 20px 20px; margin: -15px -15px 20px -15px; }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 10px; font-size: 16px; cursor: pointer; margin-top: 10px; font-weight: bold; }
        .btn-check { background: var(--primary); color: white; }
        .btn-leave { background: #007bff; color: white; }
        .info-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; font-size: 14px; }
        .section { display: none; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .back-btn { background: #eee; border: none; padding: 8px 15px; border-radius: 5px; margin-bottom: 15px; cursor: pointer; }
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    </style>
</head>
<body>

<div class="header">
    <h2 style="margin:0;">å“¡å·¥ç®¡ç†ç³»çµ± 1-1</h2>
    <div id="status" style="font-size:12px; opacity:0.8;">ç³»çµ±é€£ç·šä¸­...</div>
</div>

<div class="container">
    <div id="main-menu">
        <div class="card">
            <div id="user-display" style="font-size:18px; font-weight:bold;">è¼‰å…¥ä¸­...</div>
            <div id="user-dept" style="font-size:12px; color:gray;">æ­£åœ¨è®€å–åŸºæœ¬è³‡æ–™...</div>
        </div>
        <div class="menu-grid">
            <button class="btn btn-check" style="grid-column: span 2;" onclick="showSection('checkin')">ğŸ“ ä¸Šä¸‹ç­æ‰“å¡</button>
            <button class="btn" style="background:white; border:1px solid #ddd;" onclick="showSection('profile')">ğŸ‘¤ åŸºæœ¬è³‡æ–™</button>
            <button class="btn" style="background:white; border:1px solid #ddd;" onclick="showSection('salary')">ğŸ’° è–ªè³‡æŸ¥è©¢</button>
            <button class="btn" style="background:white; border:1px solid #ddd;" onclick="showSection('leave')">ğŸ“… è«‹å‡ç”³è«‹</button>
            <button class="btn" style="background:white; border:1px solid #ddd;" onclick="showSection('eval')">ğŸ“ˆ è€ƒç¸¾é”æˆç‡</button>
        </div>
    </div>

    <section id="profile" class="section">
        <button class="back-btn" onclick="hideAll()">â† è¿”å›</button>
        <div class="card">
            <h3>ğŸ‘¤ åŸºæœ¬è³‡æ–™</h3>
            <div id="profile-details"></div>
        </div>
    </section>

    <section id="checkin" class="section">
        <button class="back-btn" onclick="hideAll()">â† è¿”å›</button>
        <div class="card">
            <h3>ğŸ“ å‡ºå‹¤æ‰“å¡</h3>
            <p id="gps-status" style="font-size:12px; color:blue;">æ­£åœ¨å®šä½...</p>
            <button class="btn btn-check" onclick="doCheck('ä¸Šç­')">ä¸Šç­æ‰“å¡</button>
            <button class="btn" style="background:#666; color:white;" onclick="doCheck('ä¸‹ç­')">ä¸‹ç­æ‰“å¡</button>
        </div>
    </section>

    <section id="salary" class="section">
        <button class="back-btn" onclick="hideAll()">â† è¿”å›</button>
        <div class="card" id="salary-details">
            <h3>ğŸ’° æœ¬æœˆè–ªè³‡æ˜ç´°</h3>
            <p>æ­£åœ¨å¾è³‡æ–™åº«è®€å–...</p>
        </div>
    </section>

    <section id="leave" class="section">
        <button class="back-btn" onclick="hideAll()">â† è¿”å›</button>
        <div class="card">
            <h3>ğŸ“… è«‹å‡ç”³è«‹</h3>
            <label>å‡åˆ¥é¸æ“‡ï¼š</label>
            <select id="l-type" class="btn" style="background:white; border:1px solid #ddd; color:black;">
                <option>ç‰¹ä¼‘</option>
                <option>ç—…å‡</option>
                <option>äº‹å‡</option>
            </select>
            <button class="btn btn-leave" onclick="submitLeave()">é€å‡ºç”³è«‹</button>
        </div>
    </section>

    <section id="eval" class="section">
        <button class="back-btn" onclick="hideAll()">â† è¿”å›</button>
        <div class="card" id="eval-details">
            <h3>ğŸ“ˆ è€ƒç¸¾é”æˆç‡</h3>
            <p>æ­£åœ¨è®€å–è©•åˆ†è³‡æ–™...</p>
        </div>
    </section>
</div>

<script>
    // --- è€é—†è«‹ä¿®æ”¹é€™è£¡ ---
    const SUPABASE_URL = 'https://wbfaietjjgfgmgncxkbt.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_H5C7ddbzCgfKUp7MAQrUDQ_A9mGl_Pk';
    const LIFF_ID = '2009127303-ORqDH1zr';
    // --------------------

    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    let currentUser = null;

    async function init() {
        try {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) {
                liff.login();
            } else {
                const profile = await liff.getProfile();
                currentUser = profile;
                document.getElementById('status').innerText = "é€£ç·šæˆåŠŸ";
                loadEmployeeData(profile.userId);
            }
        } catch (err) {
            document.getElementById('status').innerText = "é€£ç·šå¤±æ•—: " + err;
        }
    }

    async function loadEmployeeData(userId) {
        const { data, error } = await supabaseClient.from('employees').select('*').eq('line_id', userId).single();
        if (data) {
            document.getElementById('user-display').innerText = data.name;
            document.getElementById('user-dept').innerText = "å…¥è·æ™‚é–“: " + data.onboard_date;
            
            // å¡«å……åŸºæœ¬è³‡æ–™é é¢
            document.getElementById('profile-details').innerHTML = `
                <div class="info-row"><span>é›»è©±</span><span>${data.phone || 'æœªå¡«'}</span></div>
                <div class="info-row"><span>åœ°å€</span><span>${data.address || 'æœªå¡«'}</span></div>
                <div class="info-row"><span>LINE ID</span><span>${data.line_id}</span></div>
            `;

            // å¡«å……è–ªè³‡é é¢
            document.getElementById('salary-details').innerHTML = `
                <h3>ğŸ’° è–ªè³‡å–®</h3>
                <div class="info-row"><span>åº•è–ª</span><span>$${data.base_salary}</span></div>
                <div class="info-row"><span>å…¨å‹¤çé‡‘</span><span>$${data.full_attendance_bonus}</span></div>
                <div class="info-row"><span>å‹å¥ä¿æ‰£æ¬¾</span><span>-$${data.labor_health_ins}</span></div>
                <hr><div class="info-row"><strong>å¯¦é ˜åˆè¨ˆ</strong><strong>$${data.base_salary + data.full_attendance_bonus - data.labor_health_ins}</strong></div>
            `;
            
            loadPerformance(userId);
        } else {
            document.getElementById('user-display').innerText = "æ–°å“¡å·¥ (æœªè¨»å†Š)";
        }
    }

    async function loadPerformance(userId) {
        const { data } = await supabaseClient.from('performance').select('*').eq('line_id', userId).order('id', {ascending:false}).limit(1).single();
        if (data) {
            document.getElementById('eval-details').innerHTML = `
                <h3>ğŸ“ˆ è€ƒç¸¾é”æˆç‡</h3>
                <div class="info-row"><span>è©•æ ¸æœŸé–“</span><span>${data.period}</span></div>
                <div class="info-row"><span>è€ƒç¸¾åˆ†æ•¸</span><span>${data.score}</span></div>
                <div class="info-row"><span>ç›®æ¨™é”æˆç‡</span><span>${data.achievement_rate * 100}%</span></div>
                <div style="margin-top:10px; padding:10px; background:#f9f9f9; border-radius:5px;">è©•èªï¼š${data.comments || 'ç„¡'}</div>
            `;
        }
    }

    async function doCheck(type) {
        const pos = await liff.getLocation();
        const { error } = await supabaseClient.from('attendance').insert([
            { line_id: currentUser.userId, type: type, gps_location: `${pos.latitude},${pos.longitude}` }
        ]);
        if (!error) alert(type + " æ‰“å¡æˆåŠŸï¼");
        else alert("å¤±æ•—: " + error.message);
    }

    async function submitLeave() {
        const type = document.getElementById('l-type').value;
        const { error } = await supabaseClient.from('leave_requests').insert([
            { line_id: currentUser.userId, type: type }
        ]);
        if (!error) alert("è«‹å‡ç”³è«‹å·²é€å‡ºï¼Œè«‹ç­‰å¾…è€é—†æ ¸å‡†ã€‚");
    }

    function showSection(id) {
        document.getElementById('main-menu').style.display = 'none';
        document.getElementById(id).style.display = 'block';
    }

    function hideAll() {
        document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
        document.getElementById('main-menu').style.display = 'block';
    }

    init();
</script>
</body>

</html>
