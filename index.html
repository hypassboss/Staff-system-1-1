<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HYPASS ç®¡ç†ç³»çµ± 1-1</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <style>
        :root { --main-green: #00b900; --bg: #f8f9fa; --text: #333; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; }
        .header { background: var(--main-green); color: white; padding: 30px 20px; text-align: center; border-radius: 0 0 25px 25px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .container { padding: 20px; }
        .card { background: white; padding: 20px; border-radius: 18px; box-shadow: 0 2px 12px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .hidden { display: none; }
        
        /* è¡¨å–®æ¨£å¼ */
        input { width: 100%; padding: 14px; margin: 10px 0; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 16px; }
        label { font-size: 13px; color: #666; margin-left: 5px; }
        
        /* æŒ‰éˆ•æ¨£å¼ */
        .btn { width: 100%; padding: 16px; border: none; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn-green { background: var(--main-green); color: white; }
        .btn-green:active { opacity: 0.8; transform: scale(0.98); }
        
        /* é¸å–®æ ¼ç‹€æ’åˆ— */
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .menu-item { background: white; padding: 15px; border-radius: 15px; text-align: center; border: 1px solid #eee; }
        .menu-item img { width: 30px; margin-bottom: 8px; }
    </style>
</head>
<body>

<div class="header">
    <h2 style="margin:0;">HYPASS ç®¡ç†ç³»çµ± 1-1</h2>
    <div id="loading-status" style="font-size:12px; margin-top:8px; opacity:0.8;">ç³»çµ±é€šè¨Šä¸­...</div>
</div>

<div class="container">
    <div id="loader" style="text-align:center; padding:40px;">
        <p>æ­£åœ¨ç¢ºèªæ‚¨çš„å“¡å·¥èº«åˆ†...</p>
    </div>

    <div id="ui-register" class="card hidden">
        <h3 style="margin-top:0; color:var(--main-green);">ğŸ‘‹ æ­¡è¿å…¥è·</h3>
        <p style="font-size:14px; color:#666;">è«‹å¡«å¯«åŸºæœ¬è³‡æ–™ï¼Œç³»çµ±å°‡è‡ªå‹•ç¶å®šæ‚¨çš„ LINE IDï¼Œä½œç‚ºæ—¥å¾Œæ‰“å¡èˆ‡æŸ¥è©¢è–ªè³‡çš„ä¾æ“šã€‚</p>
        <input type="text" id="reg-name" placeholder="çœŸå¯¦å§“å">
        <input type="tel" id="reg-phone" placeholder="è¯çµ¡é›»è©±">
        <label>åˆ°è·æ—¥æœŸ (å½±éŸ¿å¹´è³‡å‡è¨ˆç®—)ï¼š</label>
        <input type="date" id="reg-date">
        <button class="btn btn-green" onclick="submitRegistration()">æäº¤è³‡æ–™ä¸¦ç¶å®š</button>
</div>

    <div id="ui-main" class="hidden">
        <div class="card" style="border-left: 6px solid var(--main-green);">
            <h2 id="user-name" style="margin:0;">å“¡å·¥å§“å</h2>
            <div id="user-leave" style="margin-top:8px; font-weight:bold; color:#e67e22;">å¹´è³‡å‡ï¼šè¨ˆç®—ä¸­...</div>
            <div id="user-onboard" style="font-size:12px; color:#999; margin-top:5px;"></div>
        </div>

        <button class="btn btn-green" style="margin-bottom:20px;" onclick="handleClock()">ğŸ“ ä¸Šä¸‹ç­æ‰“å¡</button>

        <div class="menu-grid">
            <div class="menu-item" onclick="viewSalary()">ğŸ’°<br>è–ªè³‡æŸ¥è©¢</div>
            <div class="menu-item" onclick="alert('è«‹å‡æ¨¡çµ„é–‹ç™¼ä¸­')">ğŸ“…<br>è«‹å‡ç”³è«‹</div>
            <div class="menu-item" onclick="viewPerformance()">ğŸ“ˆ<br>è€ƒç¸¾é”æˆç‡</div>
            <div class="menu-item" onclick="alert('è¯çµ¡è³‡è¨Šï¼š09xx-xxx-xxx')">ğŸ“<br>åŸºæœ¬è³‡æ–™</div>
        </div>
    </div>
</div>

<script>
    // --- åƒæ•¸è¨­å®šå€ (è«‹è€é—†åœ¨æ­¤å¡«å¯«) ---
    const S_URL = 'https://wbfaietjjgfgmgncxkbt.supabase.co'.replace(/\/$/, ""); 
    const S_KEY = 'sb_publishable_H5C7ddbzCgfKUp7MAQrUDQ_A9mGl_Pk';
    const L_ID = '2009127303-4vmwjtZT';

    const supabase = supabase.createClient(S_URL, S_KEY);

    async function initSystem() {
        try {
            await liff.init({ liffId: L_ID });
            if (!liff.isLoggedIn()) {
                liff.login();
            } else {
                fetchUserData();
            }
        } catch (err) {
            document.getElementById('loading-status').innerText = "é€£ç·šå¤±æ•—ï¼š" + err.message;
        }
    }

    async function fetchUserData() {
        const profile = await liff.getProfile();
        const { data, error } = await supabase
            .from('employees')
            .select('*')
            .eq('line_id', profile.userId)
            .single();

        document.getElementById('loader').classList.add('hidden');

        if (error && error.code === 'PGRST116') {
            // æ‰¾ä¸åˆ°è³‡æ–™ -> é¡¯ç¤ºè¨»å†Šç•«é¢
            document.getElementById('ui-register').classList.remove('hidden');
            document.getElementById('reg-name').value = profile.displayName;
        } else if (data) {
            // æ‰¾åˆ°è³‡æ–™ -> é¡¯ç¤ºä¸»ç•«é¢
            renderMainUI(data);
        } else if (error) {
            alert("è³‡æ–™åº«éŒ¯èª¤ï¼š" + error.message);
        }
    }

    async function submitRegistration() {
        const profile = await liff.getProfile();
        const name = document.getElementById('reg-name').value;
        const phone = document.getElementById('reg-phone').value;
        const date = document.getElementById('reg-date').value;

        if (!name || !date) return alert("å§“åèˆ‡åˆ°è·æ—¥ç‚ºå¿…å¡«é …ç›®ï¼");

        const { error } = await supabase.from('employees').insert([{
            line_id: profile.userId,
            name: name,
            phone: phone,
            onboard_date: date,
            annual_leave_used: 0
        }]);

        if (!error) {
            alert("ç™»éŒ„æˆåŠŸï¼æ‚¨çš„ LINE å·²èˆ‡ç³»çµ±å®Œæˆç¶å®šã€‚");
            location.reload();
        } else {
            alert("è¨»å†Šå¤±æ•—ï¼š" + error.message);
        }
    }

    function renderMainUI(user) {
        document.getElementById('ui-main').classList.remove('hidden');
        document.getElementById('loading-status').innerText = "âœ… ç³»çµ±å·²å°±ç·’";
        document.getElementById('user-name').innerText = user.name;
        document.getElementById('user-onboard').innerText = "å…¥è·æ—¥æœŸï¼š" + user.onboard_date;

        // --- è‡ªå‹•å¹´è³‡å‡è¨ˆç®—é‚è¼¯ ---
        const start = new Date(user.onboard_date);
        const today = new Date();
        const diffMonth = (today.getFullYear() - start.getFullYear()) * 12 + (today.getMonth() - start.getMonth());
        
        let totalLeave = 0;
        if (diffMonth >= 6 && diffMonth < 12) totalLeave = 3;
        else if (diffMonth >= 12 && diffMonth < 24) totalLeave = 7;
        else if (diffMonth >= 24 && diffMonth < 36) totalLeave = 10;
        else if (diffMonth >= 36) totalLeave = 14;

        const remaining = totalLeave - (user.annual_leave_used || 0);
        document.getElementById('user-leave').innerText = `å¹´è³‡å‡å‰©é¤˜ï¼š${remaining} å¤© (ç¸½é¡ ${totalLeave} å¤©)`;
    }

    async function handleClock() {
        const profile = await liff.getProfile();
        const { error } = await supabase.from('attendance').insert([
            { line_id: profile.userId, type: 'æ‰“å¡' }
        ]);
        if (!error) alert("æ‰“å¡æˆåŠŸï¼æ™‚é–“å·²å­˜å…¥é›²ç«¯å¾Œå°ã€‚");
    }

    function viewSalary() {
        alert("æ¨¡çµ„é€£ç·šä¸­ã€‚è€é—†æ–¼å¾Œå°å¡«å¯«åº•è–ªå¾Œï¼Œæ­¤è™•å°‡è‡ªå‹•æ ¸ç®—è–ªè³‡å–®ã€‚");
    }

    function viewPerformance() {
        alert("æ­£åœ¨è®€å–æ‚¨çš„è€ƒç¸¾é”æˆç‡...");
    }

    initSystem();
</script>
</body>
</html>
