<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HYPASS ç®¡ç†ç³»çµ±</title>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root { --green:#00b900; --bg:#f8f9fa; }
body { font-family:sans-serif;background:var(--bg);padding:15px;margin:0; }
.card { background:white;padding:20px;border-radius:15px;
box-shadow:0 4px 10px rgba(0,0,0,0.05);margin-bottom:15px; }
input { width:100%;padding:12px;margin:8px 0;border:1px solid #ddd;
border-radius:8px;font-size:16px; }
.btn { width:100%;padding:15px;border:none;border-radius:10px;
font-size:16px;font-weight:bold;color:white;background:var(--green);cursor:pointer; }
.hidden { display:none!important; }
.label { font-size:14px;color:#666;margin-top:10px;font-weight:bold; }
</style>
</head>
<body>

<div id="loader" style="text-align:center;padding:50px;">ğŸ”„ ç³»çµ±å•Ÿå‹•ä¸­...</div>

<div id="reg-ui" class="card hidden">
<h2 style="color:var(--green);margin-top:0;">ğŸ‘‹ å“¡å·¥å…¥è·ç™»éŒ„</h2>
<div class="label">å§“å</div>
<input type="text" id="reg-name">
<div class="label">é›»è©±</div>
<input type="tel" id="reg-phone">
<div class="label">åˆ°è·æ—¥æœŸ</div>
<input type="date" id="reg-date">
<button class="btn" style="margin-top:20px;" onclick="submitReg()">æäº¤ä¸¦ç¶å®š LINE ID</button>
</div>

<div id="main-ui" class="hidden">
<div class="card" style="background:var(--green);color:white;">
<h2 id="u-name" style="margin:0;">å§“å</h2>
<div id="u-leave" style="margin-top:10px;font-size:14px;">ç‰¹ä¼‘æ ¸ç®—ä¸­...</div>
</div>
<button class="btn" style="margin-bottom:15px;" onclick="doCheck()">ğŸ“ ä¸Šä¸‹ç­æ‰“å¡</button>
</div>

<script>

// ====== å¿…å¡«å€ ======
const S_URL = 'https://wbfaietjjgfgmgncxkbt.supabase.co';
const S_KEY = 'sb_publishable_H5C7ddbzCgfKUp7MAQrUDQ_A9mGl_Pk';
const L_ID  = '2009127303-4vmwjtZT';
// ====================

let supabaseClient;
let currentUserId = null;

async function init() {
    try {

        if(!S_URL || !S_KEY){
            throw new Error("Supabase è¨­å®šæœªå¡«å¯«");
        }

        supabaseClient = supabase.createClient(S_URL, S_KEY);

        // ====== åˆ¤æ–·æ˜¯å¦åœ¨ LINE è£¡ ======
        if (typeof liff === "undefined") {
            console.warn("é LINE ç’°å¢ƒï¼Œé€²å…¥æ¸¬è©¦æ¨¡å¼");
            currentUserId = "TEST_USER_ID";
            await checkUser();
            return;
        }

        await liff.init({ liffId: L_ID });

        if (!liff.isLoggedIn()) {
            liff.login({ redirectUri: window.location.href });
            return;
        }

        const profile = await liff.getProfile();
        currentUserId = profile.userId;

        await checkUser(profile);

    } catch (err) {
        console.error("åˆå§‹åŒ–éŒ¯èª¤:", err);
        document.getElementById("loader").innerHTML =
            "âŒ å•Ÿå‹•å¤±æ•—<br><br>" + err.message;
    }
}

async function checkUser(profile=null) {

    const { data, error } = await supabaseClient
        .from('employees')
        .select('*')
        .eq('line_id', currentUserId)
        .maybeSingle();

    document.getElementById('loader').classList.add('hidden');

    if (error) {
        console.error(error);
        alert("è³‡æ–™åº«éŒ¯èª¤: " + error.message);
        return;
    }

    if (data) {
        showMainUI(data);
    } else {
        document.getElementById('reg-ui').classList.remove('hidden');
        if(profile){
            document.getElementById('reg-name').value = profile.displayName;
        }
    }
}

async function submitReg() {

    const name  = document.getElementById('reg-name').value;
    const phone = document.getElementById('reg-phone').value;
    const date  = document.getElementById('reg-date').value;

    if(!name || !phone || !date){
        alert("è«‹å¡«å¯«å®Œæ•´è³‡æ–™");
        return;
    }

    const { error } = await supabaseClient
        .from('employees')
        .insert([{
            line_id: currentUserId,
            name,
            phone,
            onboard_date: date,
            annual_leave_taken: 0,
            is_admin: false
        }]);

    if (error) {
        alert("è¨»å†Šå¤±æ•—: " + error.message);
    } else {
        alert("è¨»å†ŠæˆåŠŸï¼");
        location.reload();
    }
}

function showMainUI(user) {

    document.getElementById('main-ui').classList.remove('hidden');
    document.getElementById('u-name').innerText = user.name;

    const start = new Date(user.onboard_date);
    const today = new Date();
    const months = (today - start) / (1000*60*60*24*30);

    let total = 0;
    if (months >= 12) total = 7;
    else if (months >= 6) total = 3;

    const remain = total - (user.annual_leave_taken || 0);

    document.getElementById('u-leave').innerText =
        `åˆ°è·ï¼š${user.onboard_date} | ç‰¹ä¼‘å‰©é¤˜ï¼š${remain} å¤©`;
}

async function doCheck() {

    const { error } = await supabaseClient
        .from('attendance')
        .insert([{ line_id: currentUserId, type:'æ‰“å¡' }]);

    if (error) {
        alert("æ‰“å¡å¤±æ•—: " + error.message);
    } else {
        alert("æ‰“å¡æˆåŠŸï¼");
    }
}

init();

</script>
</body>
</html>
